document.addEventListener("DOMContentLoaded", function () {
    const printBtn = document.getElementById('btnPrint');

    if (printBtn) {
        printBtn.addEventListener('click', function () {
            const table = document.querySelector('.table-responsive')?.innerHTML || '<p>No table data</p>';

            // Get input values
            const payDate = document.getElementById('pay_date')?.value || 'N/A';
            const dateFrom = document.getElementById('date_from')?.value || 'N/A';
            const dateTo = document.getElementById('date_to')?.value || 'N/A';

            // Get current date and time
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const generatedAt = now.toLocaleString('en-US', options);

            // Get current logged-in user name (Laravel Blade interpolation)
            const generatedBy = `{{ Auth::user()->fname ?? '' }} {{ Auth::user()->lname ?? '' }}`;

            // Open print window
            const printWindow = window.open('', '', 'width=1200,height=800');

            printWindow.document.write(`
                <html>
                    <head>
                        <title>Payroll Report</title>
                        <style>
                            body {
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                color: #333;
                                padding: 20px;
                                background-color: #fff;
                            }
                            h2, h4 {
                                text-align: center;
                                margin: 0;
                            }
                            h2 {
                                font-weight: 500;
                                margin-bottom: 5px;
                                font-size: 18px;
                                color: #008080;
                            }
                            h4 {
                                font-weight: 500;
                                margin-bottom: 15px;
                                color: #555;
                            }
                            .report-header {
                                margin-bottom: 20px;
                                padding-bottom: 10px;
                                border-bottom: 2px solid #008080;
                            }
                            .report-meta {
                                margin-top: 10px;
                                font-size: 0.85rem;
                                line-height: 1.4;
                                text-align: center;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                font-size: 0.75rem;
                                margin-top: 15px;
                            }
                            th, td {
                                border: 0.5px solid #ccc;
                                padding: 6px 10px;
                                text-align: center;
                            }
                            tbody tr:nth-child(even) {
                                background-color: #f9f9f9;
                            }
                            tbody tr:hover {
                                background-color: #ffe5e5;
                            }
                            .footer {
                                margin-top: 25px;
                                font-size: 0.8rem;
                                text-align: right;
                                font-style: italic;
                                color: #555;
                            }
                            @media print {
                                body { padding: 0; }
                                table { page-break-inside: auto; }
                                tr { page-break-inside: avoid; page-break-after: auto; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="report-header">
                            <h2>Payroll Report</h2>
                            <h4>Payroll Period: ${dateFrom} to ${dateTo}</h4>
                            <div class="report-meta">
                                <strong>Payroll Date:</strong> ${payDate} <br>
                                <strong>Generated By:</strong> ${generatedBy} <br>
                                <strong>Generated On:</strong> ${generatedAt}
                            </div>
                        </div>
                        ${table}
                        <div class="footer">
                            <i>Generated from Payroll System</i>
                        </div>
                    </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        });
    }

    // Initialize jQuery once DOM is ready
    $(document).ready(function () {
        const $payrollTableBody = $('#payrollTableBody');

        // ✅ Helper: format numbers with commas and 2 decimals
        function formatNumber(value) {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // ✅ Fetch Payroll Data
        function fetchPayroll() {
            const dateFrom = $('#date_from').val();
            const dateTo = $('#date_to').val();
            const filter = $('#selFilter').val() || 'all';

            $payrollTableBody.html('<tr><td colspan="30">Loading...</td></tr>');

            axios.get('/payroll/fetch', {
                params: {
                    date_from: dateFrom,
                    date_to: dateTo,
                    filter: filter
                }
            })
                .then(function (response) {
                    const data = response.data;
                    $payrollTableBody.empty();

                    if (data.length === 0) {
                        $payrollTableBody.html('<tr><td colspan="30">No payroll data found.</td></tr>');
                        return;
                    }

                    $.each(data, function (index, payroll) {
                        const row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${(payroll.employee?.fname || '') + ' ' + (payroll.employee?.lname || '')}</td>
                                <td>${formatNumber(payroll.basic_salary)}</td>
                                <td>${formatNumber(payroll.basicPay)}</td>
                                <td>${formatNumber(payroll.reg_working_day)}</td>
                                <td>${formatNumber(payroll.reg_ot_hours)}</td>
                                <td>${formatNumber(payroll.reg_ot_amount)}</td>
                                <td>${formatNumber(payroll.night_diff_hours)}</td>
                                <td>${formatNumber(payroll.night_diff_amount)}</td>
                                <td>${formatNumber(payroll.other_earnings)}</td>
                                <td>${formatNumber(payroll.total_working_days)}</td>
                                <td>${formatNumber(payroll.total_allowance)}</td>
                                <td>${formatNumber(payroll.adjustment)}</td>
                                <td>${formatNumber(payroll.gross_pay)}</td>
                                <td>${formatNumber(payroll.tardiness_hours)}</td>
                                <td>${formatNumber(payroll.tardiness_amount)}</td>
                                <td>${formatNumber(payroll.leave_without_pay_days)}</td>
                                <td>${formatNumber(payroll.leave_without_pay_amount)}</td>
                                <td>${formatNumber(payroll.sss)}</td>
                                <td>${formatNumber(payroll.phic)}</td>
                                <td>${formatNumber(payroll.pagibig)}</td>
                                <td>${formatNumber(payroll.charges_penalties)}</td>
                                <td>${formatNumber(payroll.cash_advance)}</td>
                                <td>${formatNumber(payroll.cash_advance_balance)}</td>
                                <td>${formatNumber(payroll.total_deductions)}</td>
                                <td>${formatNumber(payroll.net_pay)}</td>
                            </tr>
                        `;
                        $payrollTableBody.append(row);
                    });
                })
                .catch(function (error) {
                    console.error(error);
                    $payrollTableBody.html('<tr><td colspan="30">Error fetching payroll data.</td></tr>');
                });
        }

        // ✅ Bind event: Fetch Payroll
        $('#btnPayroll').on('click', fetchPayroll);

        // ✅ Bind event: Generate Payroll
        $(document).on('click', '#btnGenerate', function (e) {
            e.preventDefault();
            $('#btnGenerate').prop('disabled', true).text('Generating...');

            axios.get('/payroll/compute')
                .then(function (response) {
                    fetchPayroll();
                    console.log(response.data);
                    Swal.fire({
                        icon: 'success',
                        title: 'Payroll Generated',
                        text: response.data.message || 'Payroll computation completed successfully!'
                    });
                })
                .catch(function (error) {
                    console.error(error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.response?.data?.message || 'An error occurred while generating payroll.'
                    });
                })
                .finally(function () {
                    $('#btnGenerate').prop('disabled', false).text('Generate');
                });
        });
    });
});
